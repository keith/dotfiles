#!/bin/bash

set -euo pipefail

wrapper=tools/bazel
if [[ -n "${BAZELISK_WRAPPER_DIRECTORY:-}" ]]; then
  wrapper="$BAZELISK_WRAPPER_DIRECTORY/bazel"
elif [[ -f .bazeliskrc ]]; then
  if line=$(grep BAZELISK_WRAPPER_DIRECTORY .bazeliskrc); then
    dir="${line#*=}"
    wrapper="$dir/bazel"
  fi
fi

if [[ -n "${DEV:-}" ]]; then
  if [[ -f "$wrapper" ]]; then
    BAZEL_REAL="$HOME/dev/bazelbuild/bazel/bazel-bin/src/bazel-dev" exec "$wrapper" "$@"
  fi

  exec "$HOME/dev/bazelbuild/bazel/bazel-bin/src/bazel-dev" "$@"
fi

if [[ -n "${DEV2:-}" ]]; then
  if [[ -f "$wrapper" ]]; then
    BAZEL_REAL="$HOME/dev/bazelbuild/bazel2/bazel-bin/src/bazel-dev" exec "$wrapper" "$@"
  fi

  exec "$HOME/dev/bazelbuild/bazel2/bazel-bin/src/bazel-dev" "$@"
fi

if [[ -n "${DEV3:-}" ]]; then
  if [[ -f "$wrapper" ]]; then
    BAZEL_REAL="$HOME/dev/bazelbuild/bazel3/bazel-bin/src/bazel-dev" exec "$wrapper" "$@"
  fi

  exec "$HOME/dev/bazelbuild/bazel3/bazel-bin/src/bazel-dev" "$@"
fi

if [[ -n "${DEVREL:-}" ]]; then
  if [[ -f "$wrapper" ]]; then
    BAZEL_REAL="$HOME/dev/bazelbuild/bazel-rel/bazel-bin/src/bazel-dev" exec "$wrapper" "$@"
  fi

  exec "$HOME/dev/bazelbuild/bazel-rel/bazel-bin/src/bazel-dev" "$@"
fi

bazelisk_bin=bazelisk
if [[ "${1:-}" == -x86 ]]; then
  shift
  echo "note: using x86_64 bazelisk"
  bazelisk_bin=bazelisk-darwin-amd64
fi

if [[ -n "${USE_BAZEL_VERSION:-}" ]]; then
  if command -v "$bazelisk_bin" > /dev/null; then
    exec "$bazelisk_bin" "$@"
  else
    echo "error: no $bazelisk_bin found"
    exit 1
  fi
fi

if [[ -e ./bazelw ]]; then
  exec ./bazelw "$@"
fi

# /path/to/repo/bazelw
# /path/to/repo/nested/dir/bazelw
# /path/to/repo/nested/dir/tests/BUILD
# ^ need to be able to run from here and pick up the closest bazelw
dir="$PWD"
while [[ "$dir" != "/" ]]; do
  if [[ -e "$dir/bazelw" ]]; then
    exec "$dir/bazelw" "$@"
  elif [[ -e "$dir/.git" ]]; then
    break
  fi

  dir=$(dirname "$dir")
done

if command -v "$bazelisk_bin" > /dev/null; then
  exec "$bazelisk_bin" "$@"
fi

echo "error: no $bazelisk_bin found"
exit 1
